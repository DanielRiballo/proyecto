{% extends 'base.html.twig' %}

{% block title %}Ranking de Críticas{% endblock %}

{% block stylesheets %}
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; min-height: 100vh; }

        .ranking-header {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .category-btn {
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 8px 20px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .category-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fbbf24; }
        .category-btn.active { background: #fbbf24 !important; color: #0f172a !important; border-color: #fbbf24; }

        .ranking-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            overflow: hidden;
        }

        .table-custom { margin-bottom: 0; color: #f8fafc; }
        .table-custom thead th {
            background: rgba(15, 23, 42, 0.5);
            border-bottom: 2px solid #fbbf24;
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 0.7rem;
            padding: 20px;
        }

        .table-custom tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: background 0.3s; }
        .table-custom tbody tr:hover { background: rgba(251, 191, 36, 0.05); }

        .rank-badge { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; }
        .rank-1 { background: #fbbf24; color: #000; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .rank-2 { background: #cbd5e1; color: #000; }
        .rank-3 { background: #92400e; color: #fff; }

        .movie-thumb { width: 50px; height: 75px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        .movie-link { color: #f8fafc; text-decoration: none; font-weight: 700; transition: color 0.2s; }
        .movie-link:hover { color: #fbbf24; }

        .score-badge {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 6px 12px;
            border-radius: 10px;
            font-weight: 700;
        }

        /* Estilo para cuando no hay votos */
        .score-empty { background: rgba(148, 163, 184, 0.1); color: #94a3b8; border-color: rgba(148, 163, 184, 0.2); }

        .btn-back { color: #fbbf24; text-decoration: none; font-size: 0.9rem; font-weight: 600; }
        .btn-back:hover { text-decoration: underline; }

        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 12px;
            padding: 12px 20px;
            width: 100%;
            max-width: 400px;
            transition: all 0.3s;
        }
        .search-input:focus { outline: none; border-color: #fbbf24; background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1); }
    </style>
{% endblock %}

{% block body %}
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <a href="{{ path('app_admin_dashboard') }}" class="btn-back">← Volver al Panel</a>
                <h1 class="display-5 ranking-header mt-2 mb-0">TOP {{ categoria_actual|default('GENERAL')|upper }}</h1>
            </div>
        </div>

        <div class="mb-4">
            <form action="{{ path('app_admin_ranking_genero', {genero: categoria_actual|default('')}) }}" method="get">
                <input type="text" name="q" class="search-input" placeholder="Filtrar por título..." value="{{ texto_busqueda|default('') }}">
            </form>
        </div>

        <div class="d-flex gap-2 mb-5 flex-wrap">
            <a href="{{ path('app_admin_ranking_genero') }}"
               class="category-btn {{ (categoria_actual|default('') == '') ? 'active' : '' }}">Todos</a>

            {% set generos_lista = {
                'Action': 'Acción',
                'Crime': 'Crimen',
                'Drama': 'Drama',
                'Sci-Fi': 'Ciencia Ficción',
                'Biography': 'Biografía'
            } %}

            {% for key, nombre in generos_lista %}
                <a href="{{ path('app_admin_ranking_genero', {genero: key}) }}"
                   class="category-btn {{ (categoria_actual|default('') == key) ? 'active' : '' }}">{{ nombre }}</a>
            {% endfor %}
        </div>

        <div class="ranking-card shadow-lg">
            <div class="table-responsive">
                <table class="table table-custom align-middle">
                    <thead>
                    <tr>
                        <th class="text-center" style="width: 80px;">#</th>
                        <th>Película</th>
                        <th class="text-center">Género</th>
                        <th class="text-center">Nota Media</th>
                        <th class="text-center">Votos</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for p in peliculas|default([]) %}
                        {% set nota_final = p.mediaReal|default(0) %}
                        <tr>
                            <td class="text-center">
                                <div class="d-flex justify-content-center">
                                    {% if loop.index == 1 %}<div class="rank-badge rank-1">1</div>
                                    {% elseif loop.index == 2 %}<div class="rank-badge rank-2">2</div>
                                    {% elseif loop.index == 3 %}<div class="rank-badge rank-3">3</div>
                                    {% else %}<span class="text-secondary fw-bold">{{ loop.index }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{ p.imageUrl|default('https://via.placeholder.com/50x75/1e293b/fbbf24?text=No+Image') }}" class="movie-thumb me-3" alt="{{ p.titulo|default('Peli') }}">
                                    <div>
                                        <a href="{{ path('app_pelicula_show', {id: p.id}) }}" class="movie-link d-block">
                                            {{ p.titulo|default('Sin título') }}
                                        </a>
                                        <small class="text-secondary">{{ p.year|default('S/A') }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center text-secondary small">
                                <span class="badge bg-dark border border-secondary">{{ p.genre|default('N/A') }}</span>
                            </td>
                            <td class="text-center">
                                <span class="score-badge {{ nota_final == 0 ? 'score-empty' : '' }}">
                                    ★ {{ nota_final|number_format(1) }}
                                </span>
                            </td>
                            <td class="text-center text-secondary small">
                                <i class="bi bi-chat-right-text me-1"></i> {{ p.valoraciones|length }} críticas
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-secondary italic">
                                <p class="mb-0 py-4">No hay películas que coincidan con la búsqueda.</p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
