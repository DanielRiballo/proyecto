{% extends 'base.html.twig' %}

{% block title %}Mi Ranking: {{ ranking.nombre }}{% endblock %}

{% block body %}
<style>
    .container-pro { max-width: 900px; margin: 0 auto; padding: 50px 20px; }

    .header-pro { text-align: center; margin-bottom: 40px; }
    .header-pro h1 {
        font-weight: 900; font-size: 3.5rem; margin: 0;
        background: linear-gradient(to bottom, #ffffff, #94a3b8);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-transform: uppercase;
    }
    .header-pro p { color: #38bdf8; letter-spacing: 3px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }

    #sortable-list { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }

    .movie-card {
        display: flex; align-items: center; justify-content: space-between;
        background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px 25px; border-radius: 24px;
        cursor: grab; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .movie-card:hover {
        border-color: #38bdf8;
        background: rgba(30, 41, 59, 0.7);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .movie-card:active { cursor: grabbing; transform: scale(0.98); }

    .movie-left { display: flex; align-items: center; gap: 20px; }
    .rank-num { font-size: 2rem; font-weight: 900; color: #38bdf8; width: 60px; text-align: center; }
    .poster-img { width: 65px; height: 90px; border-radius: 12px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .movie-text h3 { margin: 0; font-size: 1.3rem; color: white; font-weight: 700; }
    .movie-text span { font-size: 0.8rem; color: #94a3b8; background: rgba(56, 189, 248, 0.1); padding: 3px 10px; border-radius: 8px; font-weight: 600; }

    .sortable-ghost { opacity: 0.3; background: #38bdf8 !important; }
    .sortable-drag { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; }

    #save-toast {
        position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
        background: #10b981; color: white; padding: 12px 30px;
        border-radius: 100px; font-weight: 700; display: none; z-index: 1000;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
        animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
        from { transform: translate(-50%, 20px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }

    .btn-back {
        display: inline-block; margin-top: 40px; color: #94a3b8; text-decoration: none;
        font-weight: 600; transition: 0.3s;
    }
    .btn-back:hover { color: white; }
</style>

<div id="save-toast">✅ Tu ranking se ha actualizado automáticamente</div>

<div class="container-pro">
    <div class="header-pro">
        <p>Personaliza tu Top</p>
        <h1>{{ ranking.nombre }}</h1>
        <small style="color: #64748b;">Arrastra las películas para cambiar su posición</small>
    </div>

    <div id="sortable-list">
        {% for pelicula in peliculas %}
            <div class="movie-card" data-id="{{ pelicula.id }}">
                <div class="movie-left">
                    <div class="rank-num">#{{ loop.index }}</div>
                    <img src="{{ pelicula.imageUrl ?: 'https://via.placeholder.com/150x225?text=Cine' }}" class="poster-img">
                    <div class="movie-text">
                        <h3>{{ pelicula.titulo }}</h3>
                        <span>{{ pelicula.genre }}</span>
                    </div>
                </div>
                <div style="color: #64748b">
                    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                    </svg>
                </div>
            </div>
        {% endfor %}
    </div>

    <div style="text-align: center;">
        <a href="{{ path('app_ranking_index') }}" class="btn-back">← Volver a mis listas</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const list = document.getElementById('sortable-list');
    const toast = document.getElementById('save-toast');

    Sortable.create(list, {
        animation: 350,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        forceFallback: true, // Mejor compatibilidad táctil
        onEnd: function() {
            // Actualizar números de puesto visualmente
            document.querySelectorAll('.rank-num').forEach((el, i) => {
                el.innerText = '#' + (i + 1);
            });

            // Recopilar IDs
            const ids = Array.from(list.querySelectorAll('.movie-card')).map(el => el.dataset.id);

            // Guardar automáticamente mediante AJAX
            fetch('/ranking/{{ ranking.id }}/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    toast.style.display = 'block';
                    setTimeout(() => { toast.style.display = 'none'; }, 2500);
                }
            })
            .catch(err => console.error("Error al guardar:", err));
        }
    });
</script>
{% endblock %}
